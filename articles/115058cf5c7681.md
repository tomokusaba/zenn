---
title: "ASP.NETアプリケーションのモダナイゼーションについて"
emoji: "🚀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dotnet", "aspnet", "csharp", "modernization"]
published: false
---

## はじめに

まだまだ世の中には.NET Frameworkベースのアプリケーションがたくさん存在しています。本記事では、これらを最新の.NETにモダナイゼーションする動機や手法について解説していきます。

## モダナイゼーションとは？

**モダナイゼーション**とは、老朽化した既存システムを現在のニーズに合うように刷新することです。

具体的には、.NET Frameworkで構築されたシステムを.NETベースに刷新し、必要に応じてUIも刷新します。

## .NET Frameworkベースのアプリケーション

.NET Frameworkベースのアプリケーションは、移行の難易度によって大きく2つのグループに分けられます。

### 🟢 移行が比較的容易なグループ

.NETにも同様のフレームワークが存在するため、比較的スムーズに移行できます。

| フレームワーク | 移行先 |
|---------------|--------|
| Windows Forms | .NET Windows Forms |
| コンソールアプリ | .NET コンソールアプリ |
| ASP.NET MVC | ASP.NET Core MVC |
| WCF (クライアント) | CoreWCF または gRPC |
| WPF | .NET WPF |

### 🔴 移行が難しいグループ

.NETに同様のフレームワークがないため、アーキテクチャの変更が必要になります。

| フレームワーク | 課題 |
|---------------|------|
| ASP.NET Web Forms | 同等のフレームワークが.NETに存在しない |
| WCF (サーバーサイド) | 完全な互換性がない |
| .NET Remoting | 廃止されたテクノロジー |

:::message
Web Formsアプリケーションは、Blazorへの移行やASP.NET Core MVCへの書き換えを検討する必要があります。
:::

## なぜモダナイゼーションが必要なのか？

モダナイゼーションには様々な動機があります。

### 💰 コストの明瞭化

主にクラウドへ移行する場合、リソース使用量に基づいた明確なコスト構造が得られます。

### ☁️ クラウド運用の懸念点

.NET Frameworkアプリケーションをクラウドで運用する場合、いくつかの懸念点があります。

| 懸念点 | 詳細 |
|--------|------|
| コンテナ化 | .NET Frameworkのままコンテナ化する場合、Windowsコンテナが必要になる |
| App Service | 現時点ではホスト可能だが、将来的なサポート継続は不透明 |
| セキュリティ | セキュリティ面での不安が残る |
| 自動化 | CI/CDなど様々な自動化を推進する上で障害になる可能性がある |

:::message
クラウドネイティブな開発を進める上で、.NET Frameworkは制約となるケースが多くなっています。
:::

### ✨ 最新の機能を使用したい

- C# 13/14の新しい言語機能
- パフォーマンス向上
- 新しいライブラリやNuGetパッケージ
- コンテナ化やKubernetesとの親和性

#### 🤖 AI機能を実装したい場合

AIに関する機能を実装したい場合、`Microsoft.Extensions.AI`は.NET Framework 4.6.1以降で対応していますが、言語機能的に難しい点があります。

- サンプルコードの多くはC# 12以降を前提に書かれており、読み替えが必要
- 例えば、ストリーミング処理で`await foreach`を使いたい場合、C# 8.0以降が必要

```csharp
// C# 8.0以降で使用可能な await foreach
await foreach (var item in GetStreamingDataAsync())
{
    Console.WriteLine(item);
}
```

#### 🎛️ .NET Aspireを使いたい

.NET Aspireは.NET 8以降で利用可能なクラウドネイティブ開発のためのスタックです。

- ローカルの開発段階でダッシュボードを使ったデバッグやテレメトリー情報による性能分析が可能
- 開発初期で遅いところを潰しておける効率的な開発ができる
- 分散アプリケーションの構成管理が容易になる

### 🔒 セキュリティの問題

.NET Frameworkは新機能の追加が終了しており、セキュリティアップデートも限定的になっています。

### 📅 .NETのサポート期間について

サポート期間は.NET Frameworkと.NETで大きく異なります。

| プラットフォーム | サポート期間 |
|----------------|------------|
| .NET Framework | OSのサポート期間に準じる |
| .NET (LTS) | リリースより36ヶ月（例: .NET 8, .NET 10） |
| .NET (STS) | リリースより24ヶ月（例: .NET 9） |

:::message
.NETの場合は定期的なバージョンアップが必要になりますが、モダンな機能とセキュリティアップデートを継続的に受けられます。
:::

### ⚡ パフォーマンスの問題

.NET 10は.NET Frameworkと比較して大幅なパフォーマンス改善が施されています。

```csharp
// .NET 10では、パフォーマンスが大幅に向上
// 例: Span<T>やMemory<T>を活用した効率的なメモリ操作
ReadOnlySpan<char> span = "Hello, World!".AsSpan();
```

#### パフォーマンス改善によるメリット

- .NETは毎年多くのパフォーマンス改善がリリースされている
- 特に大規模システムの場合、サーバーのサイジングを小さくできることによって得られるコストメリットが大きい
- 同じワークロードでもより少ないリソースで処理可能になる

## .NET Frameworkにとどまる選択

モダナイゼーションは必ずしも即座に行う必要はありません。

### 🍵 塩漬けという選択肢

メリットを十分に感じられない場合は、.NET Frameworkのまま維持する選択も有効です。

### 💸 コストとのバランス

.NETにモダナイズするにはそれなりの開発費用がかかります。

:::message alert
メリットによって得られる利益と、開発費用によってかかるコストのバランスによって選択しましょう。
:::

### ⏰ いつかは必要になる

とはいえ、そのシステムが未来永劫続くとしたら、どこかの時点で.NETにモダナイゼーションすることになるかもしれません。

> **「やるかやらないか」ではなく「いつやるか」の選択**

### 📋 Cloud Adoption Framework（CAF）との関係

モダナイゼーションの意思決定は、MicrosoftのCloud Adoption Framework（CAF）における**導入戦略（Strategy）** フェーズの考え方と密接に関連しています。

CAFでは、クラウド導入で最も重要なのは「**何の目的でクラウド導入するのかを明確にする**」ことだと述べています。

:::message
**動機を明確にする**

- 🏢 データセンターを廃止したいのか？
- ⚡ システムのデリバリーを高速化したいのか？
- 🤖 AIなどの新技術を提供して新しいビジネスを展開したいのか？

**なんらかのビジネス課題があって、それをどうにかするためにクラウドを導入する！**

裏を返せば、課題がなければわざわざお金をかけてクラウド導入する意味がありません。
:::

これはモダナイゼーションにも同様に当てはまります。

**モダナイゼーションの動機の分類:**

| 分類 | 動機例 |
|------|--------|
| 🔄 **移行志向** | コスト削減、データセンター廃止、運用最適化、アジリティ向上 |
| 🚀 **イノベーション志向** | 新しいビジネス機能の実現、市場投入時間の短縮、AI導入、サステナビリティ |

CAFの導入戦略では、以下の6つのステップを通じて戦略を策定します：

1. **導入戦略を評価する** - クラウド成熟度の評価
2. **動機を決定する** - ビジネス目標との整合性確保
3. **ミッションと目標を定義** - 方向性と目的の明確化
4. **戦略チームを定義** - 適切なチーム構成
5. **組織を準備** - リーダーシップの賛同獲得
6. **戦略に情報を提供する** - セキュリティ、AI、コスト効率等の考慮事項を統合

モダナイゼーションを検討する際も、このフレームワークに沿って「なぜモダナイズするのか」を明確にし、組織全体で合意を形成することが成功への近道です。

👉 **詳細**: [Azure Cloud Adoption Framework（CAF）入門 〜導入戦略を中心に〜](https://zenn.dev/tomokusaba/articles/15a795d30bd0c8)

## モダナイゼーションにあたってやりたいこと

モダナイゼーションを始める前に、以下の準備を行うことを推奨します。

### 🗑️ 既存機能の断捨離

業務プロセスの変化によって、必ずしも全機能が使用されているとは限りません。

- 使われていない機能の洗い出し
- 費用圧縮のためにも機能の見直しは必ず行う
- 移行対象のスコープを最小限にする

### ❄️ 新規機能のフリーズ

モダナイズにあたって機能追加などは一旦フリーズしましょう。

:::message alert
モダナイズと設計変更を同時に行うと、既存機能を完璧に満たしながら機能追加かつモダナイゼーションしなければならなくなり、難易度が大幅に上昇します。
:::

## モダナイゼーションのアプローチ

### 1. ビッグバン方式

一度にすべてを書き換える方法です。

**メリット:**
- 🎯 完全に新しいアーキテクチャを採用できる
- 📦 技術的負債を一掃できる

**デメリット:**
- ⚠️ リスクが高い
- ⏱️ 長期間のプロジェクトになりがち

### 2. ストラングラーフィグパターン

段階的に新しいシステムに置き換えていく方法です。

**メリット:**
- ✅ リスクを分散できる
- 🔄 継続的にリリースできる

**デメリット:**
- 🔗 新旧システムの共存期間が必要
- 🧩 アーキテクチャが複雑になりがち

## モダン化方法の選択肢

実際にモダナイゼーションを行う際の方法について解説します。

### 🛠️ .NET Upgrade Assistant tool

Microsoftが提供する移行支援ツールです。

:::message alert
.NET Upgrade Assistantは公式に非推奨（deprecated）となりました。Visual Studio 2022 17.14.16以降では、**GitHub Copilot app modernization chat agent**の使用が推奨されています。
:::

**機能:**
- 自動で.NET Framework→.NETや.NETのバージョンアップ、診断などを実行
- プロジェクトファイルの変換
- NuGetパッケージの更新
- コードの自動修正

**対応プロジェクト:**
| プロジェクトタイプ | 対応状況 |
|------------------|----------|
| ASP.NET MVC / Web API | ✅ 対応 |
| Windows Forms | ✅ 対応 |
| WPF | ✅ 対応 |
| Azure Functions | ✅ 対応 |
| クラスライブラリ | ✅ 対応 |
| コンソールアプリ | ✅ 対応 |
| Xamarin Forms | ✅ 対応 |
| ASP.NET Web Forms | ❌ 非対応 |

:::message
独自のコンポーネントや商用コンポーネントを使用している場合、手作業が増える点に注意が必要です。必ずしもすべてがうまくいくとは限りません。
:::

### 🤖 GitHub Copilot app modernization

.NET Upgrade Assistantの後継として推奨される、AIを活用したモダナイゼーションエージェントです。

**概要:**
GitHub Copilot app modernizationは、Visual Studio内でGitHub Copilot Chatと統合して動作するエージェントです。プロジェクトの分析、アップグレード計画の生成、コードの書き換えをAIがサポートします。

**使い方:**

1. Visual Studioでプロジェクトまたはソリューションを開く
2. ソリューションエクスプローラーで右クリック → **Modernize** を選択
   または GitHub Copilot Chatで `@modernize` と入力

**3段階のワークフロー:**

| 段階 | 生成ファイル | 内容 |
|------|------------|------|
| Assessment（評価） | `assessment.md` | プロジェクト構造、依存関係、コードパターンを分析し、破壊的変更やAPI互換性の問題を特定 |
| Planning（計画） | `plan.md` | 評価結果を基に、問題解決の詳細な仕様書を作成 |
| Execution（実行） | `tasks.md` | 計画を順次実行可能なタスクに分解し、検証基準とともに記述 |

```
.github/upgrades/
├── assessment.md  # 評価レポート
├── plan.md        # 移行計画
└── tasks.md       # 実行タスク一覧
```

**主な機能:**
- 🔍 プロジェクトと依存関係の自動分析
- 📋 ステップバイステップの移行計画生成
- 🔧 自動コード修正と非推奨APIの置き換え
- ✅ 各変更のコミットによる検証・ロールバック対応
- 🏗️ ビルドエラーの自動解決
- ☁️ Azureへの移行サポート

**Azureへの移行タスク:**

GitHub Copilot app modernizationには、Azureへの移行のための定義済みタスクが含まれています。

| 移行タスク | 内容 |
|-----------|------|
| Azure SQL DB / PostgreSQL | マネージドID認証を使用したデータベース移行 |
| Azure Blob Storage | オブジェクトストレージへの移行 |
| Azure File Storage | ファイルI/O操作のクラウド移行 |
| Microsoft Entra ID | Windows ADからの認証移行 |
| Azure Key Vault | シークレット管理のセキュア化 |
| Azure Service Bus | メッセージキュー（MSMQ、RabbitMQ等）からの移行 |

:::message
GitHub Copilot app modernizationはGitリポジトリでのみ動作し、Windows環境が必要です。また、コードベースの学習やカスタム指示のトレーニングは行われません。
:::

### 💪 手動での移行

ツールが対応していないプロジェクトや、複雑なケースでは手動での移行が必要になります。

- 主にWeb Formsで構築されたシステムは手動での移行が必要
- GitHub Copilotを活用することで、ある程度の省力化が可能
- クラス設計などのアーキテクチャ設計は人間が責任を持って行う必要がある

## Web Formsのモダナイゼーション

Web Formsからの移行は最も難易度が高く、多くのプロジェクトで課題となっています。

### 推奨の移行先

**Blazor Web Apps**が推奨されますが、事実上フルスクラッチでの開発となります。

### 移行の現実

| 課題 | 詳細 |
|------|------|
| 設計アプローチ | 既存の設計書 or ソースコードをインプットに内部仕様を参考にしてフルスクラッチで設計し直す |
| 工数 | 既存設計に引っ張られるが、基本設計はある程度Passできるため、工数的にはほぼ新規開発と同等のレベル |
| 画面設計 | Web Formsの画面設計をそのまま踏襲するのではなく、再設計を検討する方がよい |
| 認証 | Entra IDのテンプレートがまだ充実していない |

:::message alert
Web Formsからの移行は、「モダナイゼーション」というより「リビルド」に近い作業になります。十分な工数と予算を見込んでおきましょう。
:::

## クラウド移行時の設計考慮事項

クラウド環境で動作させる場合、オンプレミス環境とは異なる設計上の考慮事項があります。

### 🕐 タイムゾーンについての設計

多くのクラウドリソースはUTCで動作しています。JSTを前提にして動作しているアプリケーションは時刻について混乱が生じる可能性があります。

**推奨される設計:**

| 項目 | 推奨 |
|------|------|
| 内部的な日時の扱い | UTCで統一する（あらゆるシステムからUTCで日時が取得できるので自然） |
| 日時を表現する型 | `DateTimeOffset`を使用する |
| 表示時の変換 | ViewまたはViewに近いところでJSTに変換する |

```csharp
// DateTimeOffsetを使用した例
DateTimeOffset utcNow = TimeProvider.System.GetUtcNow();

// 表示時にJSTに変換
TimeZoneInfo jst = TimeZoneInfo.FindSystemTimeZoneById("Tokyo Standard Time");
DateTimeOffset jstTime = TimeZoneInfo.ConvertTime(utcNow, jst);
```

:::message
`TimeProvider`から返される型も`DateTimeOffset`になっているため、事実上の標準となっています。
:::

### 🌐 カルチャーについて

クラウド環境はノンカルチャー（インバリアントカルチャー）で動作します。日本語カルチャーに依存するメソッドは動作しない・動作が変化する可能性があります。

**注意点:**
- `string`クラスのメソッドについては特に要注意
- ローカルの単体テストを単純に実行しただけでは、クラウド環境と実行結果が変わることがある
- カルチャーを意識した単体テストの実施が必要

```csharp
// カルチャーを明示的に指定する例
string result = value.ToUpper(CultureInfo.InvariantCulture);

// 文字列比較でカルチャーを考慮
bool isEqual = string.Equals(str1, str2, StringComparison.OrdinalIgnoreCase);
```

### 🔐 認証・認可における考慮事項

古いイントラの中だけで使われていたようなシステムの中には、認証とも言えないようなIDを識別するだけの仕組みが入っていることがあります。

- モダナイゼーションを機に、適切な認証・認可の仕組みを導入することを検討する
- Microsoft Entra ID（旧Azure AD）などのIDプロバイダーの活用を検討する
- ゼロトラストの考え方に基づいたセキュリティ設計を行う

## まとめ

| 観点 | 内容 |
|------|------|
| モダナイゼーションとは | 老朽化したシステムを現在のニーズに刷新すること |
| 移行しやすいもの | Windows Forms, コンソール, MVC, WPF |
| 移行が難しいもの | Web Forms（フルスクラッチが必要） |
| 動機 | コスト、機能、セキュリティ、パフォーマンス、クラウド対応 |
| サポート期間 | .NET FrameworkはOS依存、.NETはLTS 36ヶ月/STS 24ヶ月 |
| 準備 | 既存機能の断捨離、新規機能のフリーズ |
| ツール | .NET Upgrade Assistant（非推奨）→ GitHub Copilot app modernization |
| Web Formsの移行 | Blazor Web Apps推奨、事実上リビルド |
| クラウド移行時の設計 | タイムゾーン（UTC）、カルチャー、認証・認可 |

費用対効果を考えて.NETにモダナイゼーションしていきましょう。

とはいえ、そのシステムが続く限り、おそらくいつかは通る道です。

> **「やるかやらないか」ではなく「いつやるか」の問題**

.NET Frameworkのアプリケーションをモダナイゼーションするかどうかは、ビジネス要件や技術的な制約を考慮して判断しましょう。ただし、長期的な視点では、いずれかのタイミングでモダナイゼーションを検討することになるでしょう。

## 参考リソース

- [.NET アプリのモダナイゼーション - Microsoft Learn](https://learn.microsoft.com/ja-jp/dotnet/core/porting/)
- [ASP.NET から ASP.NET Core への移行](https://learn.microsoft.com/ja-jp/aspnet/core/migration/proper-to-2x/)
- [.NET Upgrade Assistant の概要](https://learn.microsoft.com/ja-jp/dotnet/core/porting/upgrade-assistant-overview)
- [GitHub Copilot app modernization](https://learn.microsoft.com/en-us/dotnet/core/porting/github-copilot-app-modernization/overview)
- [.NET リリースとサポート](https://learn.microsoft.com/ja-jp/dotnet/core/releases-and-support)
- [.NET Aspire のセットアップ](https://learn.microsoft.com/ja-jp/dotnet/aspire/fundamentals/setup-tooling)

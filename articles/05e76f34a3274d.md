---
title: "【周年行事】チャットアプリの.NET 10化 + 今年はMicrosoft Agent Frameworkも"
emoji: "😺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dotnet", "blazor", "csharp", "azure", "opentelemetry"]
published: false
---
# 対象のチャットアプリ

.NETラボ勉強会2022年2月の「SignalRを使ったチャットアプリの制作」で作ったチャットアプリ。

もともと、.NET 6ベースのBlazor Serverアプリで毎年アップデートし続けている。

## アプリの概要

Blazor Server + SignalR を使用したリアルタイムチャットアプリケーション。

### 主な機能

- 🔐 **個別認証によるユーザー管理**: ユーザーアカウントでログインし、ログイン名でチャット可能
- 💬 **リアルタイムチャット**: SignalRによる双方向通信でメッセージをリアルタイム送受信
- 💾 **チャット履歴の永続化**: SQL Serverでチャット内容を保存し、ページ初期表示時にロード
- 🎲 **ネタをもらう機能**: 一人でも楽しめるよう、あらかじめ登録されたネタ集からランダムでネタを取得

### カスタマイズした点

- 📝 アカウント登録時に名前を入力できるよう`Register.cshtml`を編集
- 🌐 日本語の名前を入力可能にするため`options.User.AllowedUserNameCharacters = null;`を追加
- 🏷️ ログインフォームの「Email」ラベルを「名前」に変更
- 📍 チャット入力テキストボックスが下に流れないようRazorページを調整

# .NET 10へのマイグレーション

## 一般的なマイグレーション手順

.NET 9 から .NET 10 へのマイグレーションは、Microsoft公式ドキュメントに従って進めるのが基本。

📖 **参考ドキュメント:**
- [.NET 9 の ASP.NET Core から .NET 10 の ASP.NET Core に移行する](https://learn.microsoft.com/aspnet/core/migration/90-to-100?view=aspnetcore-10.0&tabs=visual-studio&WT.mc_id=DT-MVP-5004827)
- [.NET 10 での破壊的変更](https://learn.microsoft.com/dotnet/core/compatibility/10.0?view=aspnetcore-10.0&WT.mc_id=DT-MVP-5004827#aspnet-core)

### マイグレーションの基本ステップ

1. **`global.json`で .NET SDK のバージョンを更新する**（使用している場合）
   ```diff
   {
     "sdk": {
   -    "version": "9.0.xxx"
   +    "version": "10.0.100"
     }
   }
   ```

2. **ターゲットフレームワークを更新する**
   ```diff
   <Project Sdk="Microsoft.NET.Sdk.Web">
     <PropertyGroup>
   -    <TargetFramework>net9.0</TargetFramework>
   +    <TargetFramework>net10.0</TargetFramework>
     </PropertyGroup>
   </Project>
   ```

3. **パッケージ参照の更新**
   - `Microsoft.AspNetCore.*`
   - `Microsoft.EntityFrameworkCore.*`
   - `Microsoft.Extensions.*`
   - `System.Net.Http.Json`
   
   などのパッケージの`Version`属性を`10.0.0`以降に更新する。

4. **破壊的変更の確認**
   - ASP.NET Core関連の破壊的変更をチェック
   - 使用している機能に影響がないか確認

## 今回のチャットアプリでの対応

### 破壊的変更の影響確認

.NET 10のASP.NET Core関連の破壊的変更を確認したところ、今回のチャットアプリでは以下の変更が該当しなかった：

| 破壊的変更 | 影響 |
|-----------|------|
| 🔐 Cookie ログインリダイレクトの動作変更 | 該当なし |
| ⚠️ `WithOpenApi`拡張メソッドの廃止 | 使用していない |
| 🚫 `IActionContextAccessor`の廃止 | 使用していない |
| 📝 Razorランタイムコンパイルの廃止 | 使用していない |
| 🔧 `WebHostBuilder`の廃止 | 使用していない |

### 実際に行った対応

結果として、**一般的な対応のみで.NET 10へのアップデートが完了**した！🎉

1. ✅ ターゲットフレームワークを`net10.0`に変更
2. ✅ NuGetパッケージのバージョンを10.0.0以降に更新
3. ✅ ビルド・動作確認

SignalRやBlazor Server、Entity Framework Coreを使用した基本的なチャットアプリの構成では、特別なコード修正は不要だった。

:::message
💡 毎年のアップデートを継続していると、大きなジャンプがないため移行がスムーズになる傾向がある。.NET 6 → .NET 10 のような大きなジャンプだと、より多くの破壊的変更に対応する必要があるかもしれない。
:::

# Microsoft Agent Framework対応

## Microsoft Agent Frameworkとは

2025年10月にMicrosoftから発表された新しいオープンソースのAIエージェント開発キット。🤖

📖 **公式ドキュメント:** [Microsoft Agent Framework](https://learn.microsoft.com/agent-framework/overview/agent-framework-overview?WT.mc_id=DT-MVP-5004827)

### Semantic KernelとAutoGenの統合

Microsoft Agent Frameworkは、**Semantic Kernel** と **AutoGen** の両方の強みを組み合わせた次世代フレームワーク。同じチームが開発しており、今後のAIエージェント開発の統一基盤となる。

| 特徴 | 説明 |
|------|------|
| 🔗 **マルチエージェントオーケストレーション** | 複数のエージェントを連携させる様々なパターンをサポート（Sequential、Concurrent、Hand-off、Magentic） |
| ☁️ **クラウド・プロバイダー非依存** | コンテナ、オンプレミス、マルチクラウド環境に対応。OpenAI、Azure OpenAI、Azure AI Foundryなど |
| 📊 **エンタープライズグレードのObservability** | OpenTelemetryベースの組み込み監視機能 |
| 🔒 **Microsoft Entraセキュリティ統合** | 責任あるAI機能（プロンプトインジェクション保護など） |
| 🔌 **標準ベースの相互運用性** | Agent-to-Agent (A2A) プロトコル、Model Context Protocol (MCP) との統合 |

### なぜSemantic KernelからAgent Frameworkに切り替えるのか？

今回の切り替えの最大の理由は **Application Insightsへのテレメトリ出力が標準でサポートされている** こと！🎯

Agent Frameworkは以下の機能を提供：

- 🔍 **自動インストルメンテーション**: エージェントの呼び出し、ツール実行、推論の各スコープを自動的にトレース
- 📈 **Azure Monitor連携**: Application Insightsで一元的にエージェントの動作を監視可能
- 🏷️ **OpenTelemetry標準準拠**: [GenAI Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/gen-ai/gen-ai-agent-spans/)に準拠

## Agent FrameworkでのObservability有効化

### 必要なNuGetパッケージ

```powershell
# Agent Framework本体
dotnet add package Microsoft.Agents.AI.OpenAI --prerelease

# Azure OpenAI連携
dotnet add package Azure.AI.OpenAI --prerelease
dotnet add package Azure.Identity

# OpenTelemetry対応
dotnet add package OpenTelemetry
dotnet add package OpenTelemetry.Exporter.Console
```

### コンソールへの出力（開発時）

```csharp
using OpenTelemetry;
using OpenTelemetry.Trace;

// TracerProviderを作成してコンソールに出力
using var tracerProvider = Sdk.CreateTracerProviderBuilder()
    .AddSource("agent-telemetry-source")
    .AddConsoleExporter()
    .Build();
```

### エージェントの作成とインストルメンテーション

```csharp
using Azure.AI.OpenAI;
using Azure.Identity;
using Microsoft.Agents.AI;

// エージェントを作成し、OpenTelemetryインストルメンテーションを有効化
AIAgent agent = new AzureOpenAIClient(
    new Uri("https://<myresource>.openai.azure.com"),
    new AzureCliCredential())
        .GetChatClient("gpt-4o-mini")
        .CreateAIAgent(
            instructions: "あなたはチャットのネタを提供するアシスタントです。", 
            name: "ChatNekoAssistant")
        .AsBuilder()
        .UseOpenTelemetry(sourceName: "agent-telemetry-source")
        .Build();

// エージェントを実行
Console.WriteLine(await agent.RunAsync("面白いネタをください"));
```

### トレース出力例

```
Activity.TraceId:            f2258b51421fe9cf4c0bd428c87b1ae4
Activity.SpanId:             2cad6fc139dcf01d
Activity.DisplayName:        invoke_agent ChatNekoAssistant
Activity.Tags:
    gen_ai.operation.name: chat
    gen_ai.request.model: gpt-4o-mini
    gen_ai.agent.name: ChatNekoAssistant
    gen_ai.usage.input_tokens: 26
    gen_ai.usage.output_tokens: 29
```

### Application Insightsへの出力（本番環境）

本番環境ではAzure Monitorと連携することで、Application Insightsの**Agents (Preview)** ビューでエージェントの動作を監視できる。

📖 **参考:** [Monitor AI agents with Application Insights](https://learn.microsoft.com/azure/azure-monitor/app/agents-view?WT.mc_id=DT-MVP-5004827)

```powershell
# Azure Monitor OpenTelemetry Distroを使用
dotnet add package Azure.Monitor.OpenTelemetry.AspNetCore
```

Application Insightsで確認できる内容：
- 🤖 **エージェント呼び出しのトレース**: 各エージェント実行の詳細
- 🔧 **ツール呼び出し**: どのツールがいつ呼び出されたか
- 💰 **トークン使用量**: 入力/出力トークン数とコスト分析
- ❌ **エラー診断**: 失敗したリクエストの詳細分析

## 実際にApplication Insightsで見えるもの

実際にApplication Insightsで監視した内容を簡潔にまとめる。

📖 **詳細記事:** [Microsoft Agent Frameworkの可観測性](https://zenn.dev/tomokusaba/articles/068f4ecac2d081)

### OpenTelemetryの設定ポイント（IChatClient使用時）

`IChatClient`を使用する場合も同様に`UseOpenTelemetry`でテレメトリを有効化できる。

```csharp
var client = new AzureOpenAIClient(
    endpoint: new Uri(baseUrl),
    credential: new ApiKeyCredential(key))
    .GetChatClient(deploymentName)
    .AsIChatClient()
    .AsBuilder()
    .UseOpenTelemetry(
        sourceName: openTelemetrySourceName, 
        configure: cfg => cfg.EnableSensitiveData = true)  // プロンプト内容も出力
    .Build();
```

:::message alert
⚠️ `EnableSensitiveData = true`はテスト目的で使用。本番環境ではプライバシー・セキュリティの観点から慎重に検討すること。
:::

### Application Insightsダッシュボードで見える情報

#### 概要メトリクス

| 項目 | 確認できる内容 |
|------|----------------|
| 🚨 **Alerts** | アクティブなアラート数 |
| 🤖 **Agent実行回数** | エージェントが何回実行されたか |
| 🪙 **トークン消費量** | モデルごとのトークン使用量 |

#### ツール呼び出し統計

Function Callingで呼び出されたツールの詳細が確認できる：

| ツール名 | エラー数 | 平均時間 | 呼び出し回数 |
|----------|----------|----------|--------------|
| GetPlaceId | 0 | 1.08秒 | 9回 |
| GetWeather | 0 | 49.98秒 | 10回 |

#### トークン消費分析

| 種別 | トークン数 |
|------|------------|
| 📥 **Input Tokens** | 269.1K |
| 📤 **Output Tokens** | 24.8K |

入力が出力の約10倍になるのは、システムプロンプト・ツール定義・会話履歴が入力に含まれるため。

### トレース詳細で見えるもの

トレースをドリルダウンすると、以下の情報が確認できる：

1. **システムプロンプト**: エージェントに設定した指示内容
2. **ユーザー入力**: 実際のユーザーからの入力
3. **ツール呼び出し**: LLMがどのツールを呼び出したか
4. **生成された出力**: 最終的なレスポンス

```
// トレース例：処理フロー
User: 「今日の六本木の天気を教えて」
  ↓ GetPlaceId({"place":"東京"}) → 130000
  ↓ GetWeather({"place":"130000"}) → 天気情報
  ↓ LLM応答生成
Response: 「六本木の今日の天気は...🌤️」
```

:::message
💡 **コスト最適化のヒント**: 会話が進むほど入力トークンが増加する（3987 → 4019 → 6967）。システムプロンプトの簡潔化や会話履歴の要約でコスト削減が可能。
:::

## Semantic Kernelからの移行

Semantic KernelからAgent Frameworkへの移行は比較的スムーズ。主な変更点：

| Semantic Kernel | Agent Framework |
|-----------------|-----------------|
| `Kernel`オブジェクト | `IChatClient` + `ChatClientAgent` |
| `KernelPlugin` | `AITool` + `AIFunctionFactory` |
| `ChatHistory` | `AgentThread` |

:::message
💡 **移行ガイド**: 公式の[Migration Guide from Semantic Kernel](https://learn.microsoft.com/agent-framework/migration-guide/from-semantic-kernel?WT.mc_id=DT-MVP-5004827)を参照
:::

# まとめ

## .NET 10マイグレーション

毎年継続的にアップデートしているため、今回も破壊的変更の影響なくスムーズに移行完了。🎉

## Microsoft Agent Framework導入

Semantic KernelからMicrosoft Agent Frameworkへの切り替えにより：

1. ✅ **Observabilityの大幅改善**: Application Insightsで本格的なエージェント監視が可能に
2. ✅ **将来性**: Semantic KernelとAutoGenの後継として長期サポートが期待できる
3. ✅ **エンタープライズ対応**: セキュリティ、コンプライアンス機能が標準搭載

来年もまたアップデート記事を書く予定！🚀